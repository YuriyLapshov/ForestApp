html

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта устройств</title>

    <!-- Подключаем API Яндекс.Карт -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=ваш_api_ключ&lang=ru_RU" type="text/javascript"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .device-balloon {
            padding: 10px;
            max-width: 300px;
        }

        .device-balloon h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .device-info {
            margin: 5px 0;
        }

        .status-active { color: green; font-weight: bold; }
        .status-inactive { color: red; font-weight: bold; }
        .status-error { color: orange; font-weight: bold; }
        .status-maintenance { color: blue; font-weight: bold; }

        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h3>Устройства на карте</h3>
        <div id="device-counter">Всего устройств: {{ devices|length }}</div>
        <button onclick="fitToMarkers()">Показать все устройства</button>
    </div>

    <div id="map"></div>

    <script type="text/javascript">
        // Данные устройств из Django
        const devicesData = {{ devices_json|safe }};

        // Инициализация карты
        ymaps.ready(initMap);

        let map;
        let devicePlacemarks = [];

        function initMap() {
            map = new ymaps.Map('map', {
                center: [55.7558, 37.6173], // Центр на Москву по умолчанию
                zoom: 10
            });

            // Добавляем элементы управления
            map.controls.add('zoomControl');
            map.controls.add('typeSelector');
            map.controls.add('fullscreenControl');

            // Создаем метки для каждого устройства
            devicesData.forEach(device => {
                createDevicePlacemark(device);
            });

            // Если есть устройства, центрируем карту на них
            if (devicesData.length > 0) {
                fitToMarkers();
            }

            updateDeviceCounter();
        }

        function createDevicePlacemark(device) {
            // Выбираем иконку в зависимости от статуса
            let iconColor;
            switch(device.status) {
                case 1: // Активно
                    iconColor = 'green';
                    break;
                case 2: // Ошибка
                    iconColor = 'orange';
                    break;
                case 3: // Обслуживание
                    iconColor = 'blue';
                    break;
                default: // Неактивно
                    iconColor = 'red';
            }

            const placemark = new ymaps.Placemark(
                [device.latitude, device.longitude],
                {
                    balloonContentHeader: `<h3>${device.name}</h3>`,
                    balloonContentBody: `
                        <div class="device-balloon">
                            <div class="device-info"><strong>Телефон:</strong> ${device.phone_number || 'Не указан'}</div>
                            <div class="device-info"><strong>Температура 1:</strong> ${device.temperature1 ? device.temperature1 + '°C' : 'Н/Д'}</div>
                            <div class="device-info"><strong>Температура 2:</strong> ${device.temperature2 ? device.temperature2 + '°C' : 'Н/Д'}</div>
                            <div class="device-info"><strong>Статус:</strong> <span class="status-${getStatusClass(device.status)}">${device.status_display}</span></div>
                            <div class="device-info"><strong>Обновлено:</strong> ${device.update_datetime}</div>
                            <div class="device-info">
                                <a href="https://yandex.ru/maps/?pt=${device.longitude},${device.latitude}&z=15&l=map"
                                   target="_blank" style="color: #007bff;">Открыть в Яндекс.Картах</a>
                            </div>
                        </div>
                    `,
                    hintContent: device.name
                },
                {
                    preset: `islands#${iconColor}Icon`,
                    balloonCloseButton: true,
                    hideIconOnBalloonOpen: false
                }
            );

            devicePlacemarks.push(placemark);
            map.geoObjects.add(placemark);
        }

        function getStatusClass(status) {
            switch(status) {
                case 1: return 'active';
                case 2: return 'error';
                case 3: return 'maintenance';
                default: return 'inactive';
            }
        }

        function fitToMarkers() {
            if (devicePlacemarks.length > 0) {
                const bounds = map.geoObjects.getBounds();
                if (bounds) {
                    map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 20 });
                }
            }
        }

        function updateDeviceCounter() {
            const counter = document.getElementById('device-counter');
            counter.textContent = `Всего устройств: ${devicesData.length}`;
        }

        // Автоматическое обновление карты каждые 5 минут
        setInterval(() => {
            window.location.reload();
        }, 300000);
    </script>
</body>
</html>