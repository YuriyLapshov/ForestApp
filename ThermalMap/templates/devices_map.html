html

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</title>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=–≤–∞—à_api_–∫–ª—é—á&lang=ru_RU" type="text/javascript"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .device-balloon {
            padding: 10px;
            max-width: 300px;
        }

        .device-balloon h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .device-info {
            margin: 5px 0;
        }

        .status-active { color: green; font-weight: bold; }
        .status-offline { color: black; font-weight: bold; }
        .status-online { color: blue; font-weight: bold; }
        .status-error { color: orange; font-weight: bold; }


        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="controls">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h3 style="margin: 0;">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</h3>

            {% if user.is_authenticated %}
                <div style="display: flex; align-items: center; gap: 10px; background-color: #f8f9fa; padding: 5px 10px; border-radius: 4px;">
                    <span style="font-size: 14px; color: #495057;">
                        üë§ <strong>{{ user.username }}</strong>
                    </span>
                    <span style="color: #dee2e6;">|</span>
                    <form method="post" action="{% url 'admin:logout' %}" style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit"
                                style="background: none; border: none; color: #6c757d; cursor: pointer; font-size: 13px; padding: 0; text-decoration: underline;">
                            –í—ã–π—Ç–∏
                        </button>
                    </form>
                </div>
            {% else %}
                <a href="{% url 'admin:login' %}"
                   style="font-size: 14px; color: #0d6efd; text-decoration: none;">
                    ‚Üí –í–æ–π—Ç–∏
                </a>
            {% endif %}
        </div>

        <div id="device-counter" style="margin-bottom: 15px;">–í—Å–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: {{ devices|length }}</div>

        <div class="button-group" style="display: flex; flex-direction: column; gap: 10px; max-width: 300px;">
            <button onclick="fitToMarkers()"
                    style="width: 100%; padding: 12px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            </button>

            <form method="post" action="{% url 'poll_devices' %}" style="width: 100%; margin: 0;">
                {% csrf_token %}
                <button type="submit"
                        style="width: 100%; padding: 12px; background-color: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                    –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                </button>
            </form>

            <a href="{% url 'admin:index' %}" style="width: 100%; text-decoration: none;">
                <button type="button"
                        style="width: 100%; padding: 12px; background-color: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
                </button>
            </a>
        </div>
    </div>

    <div id="map"></div>

    <script type="text/javascript">
        // –î–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏–∑ Django
        const devicesData = {{ devices_json|safe }};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        ymaps.ready(initMap);

        let map;
        let devicePlacemarks = [];

        function initMap() {
            map = new ymaps.Map('map', {
                center: [55.7558, 37.6173], // –¶–µ–Ω—Ç—Ä –Ω–∞ –ú–æ—Å–∫–≤—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                zoom: 10
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            map.controls.add('zoomControl');
            map.controls.add('typeSelector');
            map.controls.add('fullscreenControl');

            // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            devicesData.forEach(device => {
                createDevicePlacemark(device);
            });

            // –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –Ω–∏—Ö
            if (devicesData.length > 0) {
                fitToMarkers();
            }

            updateDeviceCounter();
        }

        function createDevicePlacemark(device) {
            // –í—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
            let iconColor;
            switch(device.status) {
                case 0:  //–ù–µ—Ç –ø–∏—Ç–∞–Ω–∏—è
                    iconColor = 'black';
                    break;
                case 1: // –ê–∫—Ç–∏–≤–Ω–æ
                    iconColor = 'green';
                    break;
                case 2: // –û—à–∏–±–∫–∞
                    iconColor = 'red';
                    break;
                case 3: // –û—à–∏–±–∫–∞
                    iconColor = 'red';
                    break;
                case 4: // –ü–∏—Ç–∞–Ω–∏–µ –ø–æ–¥–∞–Ω–æ
                    iconColor = 'blue';
                    break;
                default: // –ù–µ–∞–∫—Ç–∏–≤–Ω–æ
                    iconColor = 'red';
                    break;
            }

            const placemark = new ymaps.Placemark(
                [device.latitude, device.longitude],
                {
                    balloonContentHeader: `<h3>${device.name}</h3>`,
                    balloonContentBody: `
                        <div class="device-balloon">
                            <div class="device-info"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${device.phone_number || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            <div class="device-info"><strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 1:</strong> ${device.temperature1 ? device.temperature1 + '¬∞C' : '–ù/–î'}</div>
                            <div class="device-info"><strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 2:</strong> ${device.temperature2 ? device.temperature2 + '¬∞C' : '–ù/–î'}</div>
                            <div class="device-info"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-${getStatusClass(device.status)}">${device.status_display}</span></div>
                            <div class="device-info"><strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${device.update_datetime}</div>
                            <div class="device-info">
                                <a href="https://yandex.ru/maps/?pt=${device.longitude},${device.latitude}&z=15&l=map"
                                   target="_blank" style="color: #007bff;">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö</a>
                            </div>

                        </div>
                    `,
                    hintContent: device.name
                },
                {
                    preset: `islands#${iconColor}Icon`,
                    balloonCloseButton: true,
                    hideIconOnBalloonOpen: false
                }
            );

            devicePlacemarks.push(placemark);
            map.geoObjects.add(placemark);
        }

        function getStatusClass(status) {
            switch(status) {
                case 0: return 'offline';
                case 1: return 'active';
                case 2: return 'error';
                case 3: return 'error';
                case 4: return 'online';
                default: return 'offline';
            }
        }

        function fitToMarkers() {
            if (devicePlacemarks.length > 0) {
                const bounds = map.geoObjects.getBounds();
                if (bounds) {
                    map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 20 });
                }
            }
        }


        function updateDeviceCounter() {
            const counter = document.getElementById('device-counter');
            counter.textContent = `–í—Å–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${devicesData.length}`;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(() => {
            window.location.reload();
        }, 300000);
    </script>
</body>
</html>